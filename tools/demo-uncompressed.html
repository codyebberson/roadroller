<!doctype html><meta charset=utf-8><title>Roadroller: Flattens Your JavaScript Demo</title><a id=github href=https://github.com/lifthrasiir/roadroller/ style=display:grid;place-content:center;position:fixed;top:0;left:0;bottom:0;right:0;background:#2f2f2f;color:#fff;text-decoration:none>Page not loading? Please take a look at GitHub instead.</a><script>document.write`<style>#github{z-index:9;opacity:1;transition:opacity .2s}#github[hidden]{display:grid;opacity:0;pointer-events:none}html{background:#f2f2f2;color:#111;box-sizing:border-box;font:16px arial;line-height:1.5}code,pre,textarea{font:15px courier,monospace}.c\\$1f:before,code,pre{background:#ffd07d}*,:after,:before{box-sizing:inherit}body,h1,h2,h3,ol,p,td,th,ul{padding:0;font-weight:400}body{margin:0 auto;max-width:60em}ol,p,ul{margin:1em 0}address,h1,h2,h3{color:#415aa6}h1{font-size:3em;margin:.5em 0 0}h2,h3{margin:1.5em 0 0}hgroup{text-align:center;line-height:1.2}hgroup>*{font-weight:700}hgroup>h2{font-size:1.2rem;margin-top:0}a{color:#418fbf}a[title=Help]{text-decoration:none}table{background:#f2f2f280;border-collapse:collapse}td,th{border:1px solid #591902;padding:0 .5em;text-align:left;vertical-align:top}th{background:#ffd07d80;white-space:nowrap}ol,ul{list-style-position:inside}pre{margin:1em -.5em;padding:.5em;overflow:auto}code{padding:0 .1em}.c\\$1f{font-size:0}.c\\$1f:before{font-size:1rem;content:'<U+001F>';color:red}address{margin:3em 0 1em}address svg{float:right;width:3em;margin-top:-1.5em;vertical-align:middle;fill:currentcolor}@media screen and (max-width:62em){body{margin:0 1em}}div:target,p:target{border-left:.25em solid #415aa6;padding-left:.25em;margin-left:-.5em;background:linear-gradient(to right,#415aa640,#415aa600)}fieldset{border:1px solid #591902;border-radius:12px 12px 10px 10px;margin:.5em 0;padding:0;position:relative;display:flex;flex-direction:column}fieldset>header{background:#591902;color:#f2f2f2;padding:.2em .5em;width:100%;border-radius:10px 10px 0 0;display:flex}fieldset>header>span{flex:1}fieldset>header input{background:inherit;color:inherit;border:0;border-bottom:1px solid #fff;width:10em}fieldset>footer{border-top:1px solid #591902;color:#591902;padding:.2em .5em;width:100%;order:4}fieldset>footer ul{margin:0}fieldset>footer ul.c\\$inline{display:flex;flex-wrap:wrap;column-gap:2em}fieldset>footer li{list-style:none}fieldset>pre{margin:0;padding:.5em;order:3;white-space:pre-wrap;word-break:break-all;user-select:all}fieldset>pre>span:first-child{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}fieldset>textarea{width:100%;background:#fff;border:0;margin:0;padding:.5em;resize:vertical;min-height:10em;order:3}fieldset>aside{font-size:80%;color:red;padding:.2rem .5rem 0;order:2}fieldset.c\\$input>aside{background:#fff}fieldset.c\\$output>aside{background:#ffd07d}fieldset.c\\$outdated>pre{color:#1118}input[type=number]{width:5em}</style><hgroup><h1>Roadroller</h1><h2>Flattens Your JavaScript Demo</h2></hgroup><div id=$inputs></div><template id=$inputtemplate><fieldset class=c$input><header><span><strong>Input</strong> (<span id=i$size>0</span>B)</span></header><textarea id=i$data></textarea><aside id=i$message></aside><footer><ul class=c$inline><li><label>Type: <select id=i$type><option value=js>JavaScript<option value=text>Text</select> <a href=#input-type title=Help>ℹ️</a><li><label>Action: <select id=i$action><option value=eval id=i$action$eval>Evaluate<option value=write id=i$action$write>Write to document</select> <a href=#input-action title=Help>ℹ️</a></template><fieldset id=$output class=c$output><header><span><strong>Output</strong> (<span id=$outputsize>0B estimated</span>)</span><button id=$newwindow hidden>Test in new window</button></header><pre><span id=$output1></span><span id=$output2></span></pre><aside id=$outputmessage></aside><footer><ul><li><button id=$optimizecontexts>Optimize contexts</button> <a href=#optimize-contexts title=Help>ℹ️</a><li><label>Maximum memory usage: <input id=$maxmemory type=number value=150 min=10 max=1024> MB (<span id=$estimatedmemory>120</span> MB estimated) <a href=#max-memory title=Help>ℹ️</a></ul></footer></fieldset><main id=$demotext><p><strong><a href=https://github.com/lifthrasiir/roadroller>Roadroller</a></strong> is a heavyweight JavaScript packer designed for large <a href=https://en.wikipedia.org/wiki/Demoscene>demos</a> of at least 10 KB in size, like <a href=https://js13kgames.com/>js13kGames</a>. Depending on the input it can provide up to 10% additional compression compared to <a href=https://github.com/google/zopfli>Zopfli</a>.<p>Roadroller is considered “heavyweight” unlike typical JS packers such as <a href=http://www.iteral.com/jscrush/>JSCrush</a> or <a href=https://siorki.github.io/regPack.html>RegPack</a>, because it is quite resource intensive and requires both a considerable amount of memory and a non-negligible run time. The default should work for most devices, but you can configure both aspects as you need.<h2>Usage</h2><p>By default Roadroller receives your JS code and returns a compressed JS code that should be further compressed with ZIP/gzip (or more accurately, <a href=https://en.wikipedia.org/wiki/Deflate>DEFLATE</a>). Ideally your JS code should be already minified, probably using <a href=https://terser.org/>Terser</a> or <a href=https://closure-compiler.appspot.com/home>Closure Compiler</a>; Roadroller only does a minimal whitespace and comment suppression.<p>The resulting code will look like this:<pre>_='Zos~ZyF_sTdvfgJ^bIq<span class=c$1f>&#31;</span>_wJWLGSIz}<span class=c$1f>&#31;</span>Chb?rMch}...'&#10;t=12345678;M=1&lt;&lt;17;w=[0,0,0,0,0,0,0,0,0,0,0,0];p=new Uint32Array(12&lt;&lt;21).fill(M/4);/* omitted */;eval(c)</pre><p>The first line is a compressed data. It can contain control characters <code class=c$1f>&#31;</code> that might not render in certain environments. Nevertheless you should make sure that they are all copied in verbatim.<p>The second line is a compressor tuned for this particular input. By default the decompressed data immediately goes through <code>eval</code>, but you can configure what to do with that.<p>The first line is very incompressible unlike the second line, so ideally you should compress two lines separately. This is best done by using ADVZIP from <a href=http://www.advancemame.it/comp-readme>AdvanceCOMP</a> or the aforementioned Zopfli. It is also possible but not recommended<sup>*</sup> to put the first line to a separate file and load it with a separate <code>&lt;script&gt;</code> tag.<blockquote><p><small>* This is not recommended because any additional file to ZIP incurs at least 88+2n bytes of overhead where n is the length of file name and that overhead mostly negates the additional compression. Instead put everything into a single file and run ADVZIP or Zopfli.</small></blockquote><h3>Input Configuration</h3><p>Each input can be further configured by input type and action.<div id=input-type><p><strong>Input type</strong> determines the preprocessing step to improve the compression.<table><tr><th>JavaScript<td>Assumes a valid JS code. Automatically removes all redundant whitespace and comments and enables a separate modelling for embedded strings. This also works for JSON.<tr><th>Text<td>Assumes a human-readable Unicode text that can be encoded in UTF-8. This can also be used for JavaScript code that should not undergo preprocessing.</table></div><div id=input-action><p><strong>Input action</strong> determines what to do with the decompressed data.<table><tr><th>Evaluate<td>Evaluates the decompressed JavaScript code. If there are multiple inputs there should be exactly one JavaScript input with evaluate action, since subsequent inputs will be decompressed in that code. The resulting value is always a code string, which may include decoders for subsequent inputs.<tr><th>Write to document<td>Writes a decompressed string to <code>document</code>. Typically used with HTML.</table></div><h3>Output Configuration</h3><p id=optimize-contexts><strong>Optimize contexts</strong> button searches for better modelling parameters. Parameters are solely related to the compression ratio so you can try this as many as you can afford.<p id=max-memory><strong>Maximum memory usage</strong> configures the maximum memory to be used both for compression and decompression. Increasing or decreasing memory usage only affects the compression ratio and not the run time. The actual memory usage can be as low as a half of the specified due to the internal architecture. The default is 150 MB.<h2>Command-line Usage and API</h2><p>Roadroller is available as an <a href=https://www.npmjs.com/package/roadroller>NPM package</a>:<pre>$ npx roadroller input.js -o output.js</pre><p>You can also use Roadroller as a library to integrate with your build pipeline. Please take a look at the <a href=https://github.com/lifthrasiir/roadroller>GitHub project page</a> for details.</p></main><address>Roadroller is brought to you by <a href=https://mearie.org/><svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 182 186"><path d="M0 0h54v102H19v52h35v32H0m34-70h20v24H34"/><path d="M64 0h54v1e2a22 22 0 000 56v30H64m54-72a12 12 0 000 28v-28"/><path d="M128 0h54v102h-33v12h33v8h-33v32h33v32h-54m35-52h19v8h-19"/></svg>Kang Seonghoon</a>.`;class e{constructor({outBits:e,precision:t}){this.precision=t,this.outBits=e,this.input=[]}writeBit(e,t){if(0!==e&&1!==e)throw Error("AnsEncoder.writeBit: bad bit");if(t!==~~t||t<0||t>=1<<this.precision)throw Error("AnsEncoder.writeBit: bad predictedFreq");if(this.finished)throw Error("AnsEncoder.writeBit: already finished");this.input.push({bit:e,predictedFreq:t})}finish(){if(this.finished)throw Error("AnsEncoder.writeBit: already finished");this.finished=!0;var e=1<<28-this.outBits,t=(1<<this.outBits)-1,r=e,i=[],s=this.precision+1;for(var{bit:n,predictedFreq:a}of this.input.reverse()){var o,h,u=a<<1|1;n?(o=0,h=u):(o=u,h=(1<<s)-u);for(var c=(e>>s<<this.outBits)*h;r>=c;)i.push(r&t),r>>=this.outBits;if((r=((r/h|0)<<s)+r%h+o)>=2147483648)throw Error("ANSEncoder.finish: state overflow")}return i.reverse(),{state:r,buf:i}}}var t=e=>class extends e{constructor(e,...t){super(...t),this.inBits=e,this.bitCount=0,this.currentByte=0}predict(e){return super.predict(e)}update(e,t){super.update(e,t),this.currentByte=this.currentByte<<1|e,++this.bitCount===this.inBits&&(this.updateByte(this.currentByte),this.bitCount=this.currentByte=0)}updateByte(e){super.updateByte&&super.updateByte(e)}};class r{constructor({inBits:e,contextBits:t,precision:r,modelMaxCount:i,arrayBufferPool:s}){this.inBits=e,this.contextBits=t,this.precision=r,this.modelMaxCount=i,this.arrayBufferPool=s,s?(this.predictions=s.newUint32Array(this,1<<t),this.counts=s.newUint8Array(this,1<<t)):(this.predictions=new Uint32Array(1<<t),this.counts=new Uint8Array(1<<t)),this.predictions.fill(1<<r-1),this.counts.fill(0),this.bitContext=1}predict(e=0){return this.predictions[e=e+this.bitContext&(1<<this.contextBits)-1]}update(e,t=0){if(0!==e&&1!==e)throw Error("DirectContextModel.update: bad actualBit");this.counts[t=t+this.bitContext&(1<<this.contextBits)-1]<this.modelMaxCount&&++this.counts[t];var r=((e<<this.precision)-this.predictions[t])*(1<<30-this.precision);if(r<-2147483648||r>2147483647)throw Error("DirectContextModel.update: delta overflow");this.predictions[t]+=(r/(2*this.counts[t]+1)|0)>>29-this.precision,this.bitContext=this.bitContext<<1|e,this.bitContext>>this.inBits>0&&(this.bitContext=1)}release(){this.arrayBufferPool&&(this.predictions&&this.arrayBufferPool.release(this.predictions.buffer),this.counts&&this.arrayBufferPool.release(this.counts.buffer),this.predictions=null,this.counts=null)}}class i extends(t(r)){constructor(e){super(e.inBits,e),this.selector=e.sparseSelector,this.recentBytes=[];for(var t=0;this.selector>>t>0;++t)this.recentBytes.push(0);this.sparseContext=0}predict(e=0){return super.predict(this.sparseContext+e)}update(e,t=0){super.update(e,this.sparseContext+t)}updateByte(e){super.updateByte(e),this.recentBytes.unshift(e),this.recentBytes.pop();for(var t=0,r=this.recentBytes.length-1;r>=0;--r)this.selector>>r&1&&(t=997*(t+this.recentBytes[r])|0);this.sparseContext=t}}class s{constructor(e,{learningRateNum:t,learningRateDenom:r,precision:i}){this.models=e,this.precision=i,this.learningRateNum=t,this.learningRateDenom=r,this.mixedProb=0,this.stretchedProbs=[],this.weights=[];for(var s=0;s<e.length;++s)this.stretchedProbs.push(0),this.weights.push(0)}predict(e=0){for(var t=0,r=0;r<this.models.length;++r){var i=this.weights[r],s=2*this.models[r].predict(e)+1,n=Math.log(s/((2<<this.precision)-s));this.stretchedProbs[r]=n,t+=i*n}var a=(2<<this.precision)/(1+Math.exp(-t));if(a>=2<<this.precision)throw Error("LogisticMixModel.predict: weighted average overflow");return this.mixedProb=1|a,this.mixedProb>>1}update(e,t=0){for(var r=this.mixedProb/(2<<this.precision),i=0;i<this.models.length;++i){this.models[i].update(e,t);var s=this.stretchedProbs[i];this.weights[i]+=(s=s*this.learningRateNum/this.learningRateDenom)*(e-r)}}release(){for(var e of this.models)e.release&&e.release()}}class n extends(t(s)){constructor(e){var{inBits:t,sparseSelectors:r,modelQuotes:s}=e;super(t,r.map((t=>new i({sparseSelector:t,...e}))),e),this.modelQuotes=s,this.quote=0,this.quotesSeen=new Set}predict(e=0){return this.quote>0&&(e+=129),super.predict(e)}update(e,t=0){this.quote>0&&(t+=129),super.update(e,t)}updateByte(e){super.updateByte(e),this.modelQuotes&&(this.quote&&this.quote===e?this.quote=0:!this.quote&&[34,39,96].includes(e)&&(this.quote=e,this.quotesSeen.add(e)))}}class a{constructor(e,t={}){t.sparseSelectors=t.sparseSelectors||[0,1,2,3,6,7,13,21,25,42,50,57],t.maxMemoryMB=t.maxMemoryMB||150,t.contextBits=t.contextBits||Math.log2(t.maxMemoryMB/t.sparseSelectors.length/5)+20|0,t.precision=t.precision||16,t.modelMaxCount=t.modelMaxCount||63,t.learningRateNum=t.learningRateNum||1,t.learningRateDenom=t.learningRateDenom||256,this.options=t,this.inputsByType={},this.evalInput=null;for(var r=0;r<e.length;++r){e[r].index=r;var{data:i,type:s,action:n}=e[r];if(!["js","glsl","html","text","binary"].includes(s))throw Error("Packer: unknown input type");if(!["eval","json","string","write","console","array","u8array","base64"].includes(n))throw Error("Packer: unknown input action");if("string"==typeof i&&"binary"===s)throw Error("Packer: binary input should have an array-like data");if("string"!=typeof i&&"binary"!==s)throw Error("Packer: non-binary input should have a string data");if(!["js","text"].includes(s)&&["eval","json"].includes(n))throw Error("Packer: eval or json actions can be used only with js inputs");if("binary"===s&&["string","write","console"].includes(n))throw Error("Packer: binary inputs cannot use string or write action");if(this.inputsByType[s]=this.inputsByType[s]||[],this.inputsByType[s].push(e[r]),"eval"===n){if(this.evalInput)throw Error("Packer: there can be at most one input with eval action");this.evalInput=e[r]}}if(1!==e.length||!["js","text"].includes(e[0].type)||!["eval","write","console"].includes(e[0].action))throw Error("Packer: this version of Roadroller supports exactly one JS or text input, please stay tuned for more!")}prepare(){this.combinedInput||(this.preparedText=a.prepareText(this.inputsByType.text||[],this.options),this.preparedJs=a.prepareJs(this.inputsByType.js||[],this.options),this.combinedInput=[...this.preparedText.text,...this.preparedJs.code].map((e=>e.charCodeAt(0))),this.options.inBits=this.combinedInput.every((e=>e<=127))?7:8,this.options.outBits=6,this.options.modelQuotes=this.preparedJs.length>0)}static prepareText(e){var t=e.map((e=>e.data)).join("");return t.match(/[\u0100-\uffff]/)?{utf8:!0,text:unescape(encodeURIComponent(t))}:{utf8:!1,text:t}}static prepareJs(e,{minFreqForAbbrs:t=1}={}){var r=new Map;for(var i of e){var s=[];for(var n of j(i.data)){if(!1===n.closed)throw Error("Packer: invalid JS code in the input");switch(n.type){case d:case c:case p:continue;case f:if((s[s.length-1]||{}).type===f)continue;n.value="\n";break;case l:n.value.length>1&&r.set(n.value,(r.get(n.value)||0)+1);break;case h:case u:if(n.closed)try{forbiddenIdents.add((0,eval)(n.value))}catch{}break;case v:throw Error("Packer: invalid JS code in the input")}n.value=n.value.replace(/\r\n?/g,"\n").replace(/[^\n\x20-\xff]/g,(e=>"\\u"+e.charCodeAt(0).toString(16).padStart(4,"0"))),s.push(n)}(s[s.length-1]||{}).type===f&&s.pop(),i.tokens=s}for(var a=new Set,o=0;o<128;++o)[34,39,96].includes(o)||a.add(String.fromCharCode(o));for(var i of e)for(var n of i.tokens)for(var y of n.value)a.delete(y);var m,g=[...a].sort(),x=[...r.entries()].map((([e,r])=>[e,e.length*(r-t)])).filter((([,e])=>e>0)).sort((([,e],[,t])=>t-e)).slice(0,g.length).map((([e],t)=>[e,g[t]])),w=new Map(x),b="",$={},B=new Set;for(var i of e)for(var n of i.tokens)n.type===l&&(n.abbr=w.get(n.value)),m&&(m.type===l&&n.value.match(/^[\w$\\]/)||(m.value+" "+n.value).match(/^\/ \/|\/ in(?:stanceof)?$|^(?:\+ \+|- -|! --|-- >)$/))&&(m.abbr?n.abbr?B.add(m.abbr+n.abbr):$[m.abbr]|=2:n.abbr?$[n.abbr]|=1:b+=" "),b+=n.abbr||n.value,m=n;for(;0!==(B=new Set([...B].filter((e=>!(2&$[e[0]]||1&$[e[1]]))))).size;){var C=new Map;for(var M of B){var S=M.charCodeAt(0)<<1,I=M.charCodeAt(1)<<1|1;C.set(S,(C.get(S)||0)+1),C.set(I,(C.get(I)||0)+1)}var[[k]]=[...C.entries()].sort((([e,t],[r,i])=>i-t||e-r));$[String.fromCharCode(k>>1)]|=1&k?1:2}var A="";for(var[E,P]of x)1&$[P]&&(A+=" "),A+=E,2&$[P]&&(A+=" "),A+=P;return{abbrs:x,code:A+b}}makeDecoder(){this.prepare();var{sparseSelectors:t,inBits:r,outBits:i,contextBits:s,precision:a,modelMaxCount:o,learningRateNum:h,learningRateDenom:u}=this.options,c=new n(this.options),{buf:p,state:l,inputLength:d,bufLengthInBytes:f}=function(t,r,i){for(var{inBits:s,outBits:n,precision:a,calculateByteEntropy:o}=i,h=new e(i),u=[],c=0;c<t.length;++c){for(var p=t[c],l=o?1:0,d=s-1;d>=0;--d){var f=p>>d&1,v=r.predict();l&&(l*=2*(f?v:(1<<a)-v)+1),h.writeBit(f,v),r.update(f)}o&&u.push(l)}r.release&&r.release();var y,{state:m,buf:g}=h.finish();return o&&(y=u.map((e=>(a+1)*s-Math.log2(e)))),{state:m,buf:g,inputLength:t.length,bufLengthInBytes:Math.ceil(g.length*n/8),byteEntropy:y}}(this.combinedInput,c,this.options),v=t.length,y=[];for(var m of t){for(var g=[],x=0;1<<x<=m;++x)m>>x&1&&g.push(x+1);y.push(g.reverse())}var w,b=[...c.quotesSeen].sort(((e,t)=>e-t)),$=e=>({"\0":"\\0","\r":"\\r","\\":"\\\\","]":"\\]"}[e]||e),B=(e,t)=>{for(var i=[],s=-1,n=0;n<=1<<r;++n)if(n<1<<r&&e.has(n)===t)s<0&&(s=n);else if(s>=0){var a=n-1,o=$(String.fromCharCode(s));s+1<a&&(o+="-"),s<a&&(o+=$(String.fromCharCode(a))),i.push(o),s=-1}return i.length>0&&"^"===i[0][0]&&(i.length>1?i.push(i.unshift()):i[0]="\\"+i[0]),(t?"":"^")+i.join("")},C=`_='${String.fromCharCode(...p.map((e=>28===e||63===e?e:64|e)))}'`,M=`t=${l};M=1<<${a+1};w=${JSON.stringify(Array(v).fill(0))};p=new Uint32Array(${v}<<${s}).fill(M/4);c=new Uint8Array(${v}<<${s}).fill(1);for(z=[r=k=${b.length>0?"f=":""}0];k<${d};z[k++]=v-=`+(1<<r)+(b.length>0?",f=f?v-f&&f:"+(b.length>1?`(${b.map((e=>"v=="+e)).join("|")})&&v`:`v==${b[0]}&&v`):"")+")"+`for(v=1;v<${1<<r};u.map((j,i)=>(y=p[j]+=`+`(b*M/2-p[j]<<${30-a})/`+`(c[j]+=2*(c[j]<${2*o}))`+`>>${29-a},w[i]+=x[i]*(b-q/M))),v=v*2+b)for(`+`u='${y.map((e=>e.join(""))).join("0")}'.split(q=0).map((j,i)=>`+`((1<<${s})-1&[...j].reduce((j,i)=>j*997+(z[k-i]|0)|0,0)*997+v`+(b.length>0?"+!!f*129":"")+`)*${v}+i),x=u.map((j,i)=>(y=p[j]*2+1,y=Math.log(y/(M-y)),q-=w[i]*y,`+`y${1==h?"":"*"+h}/${u})),q=M/(1+Math.exp(q))|1,b=t%M<q,`+`t=(b?q:M-q)*(t>>${a+1})+t%M-!b*q;t<M<<`+(27-i-a)+";"+`t=t<<${i}|_.charCodeAt(r++)&${(1<<i)-1});`,S="c",[I]=this.inputsByType.text||this.inputsByType.js;switch(I.type){case"text":S=this.preparedText.utf8?"c=w=decodeURIComponent(escape(String.fromCharCode(...z)))":"c=w=String.fromCharCode(...z)";break;case"js":if(0===this.preparedJs.abbrs.length)S="c=w=String.fromCharCode(...z)";else if(this.preparedJs.abbrs.length<3)for(var[,k]in M+="c=w=String.fromCharCode(...z);",this.preparedJs.abbrs)M+=`with(c.split(\`${w=k,{"\0":"\\0","\r":"\\r","\\":"\\\\","`":"\\`"}[w]||w}\`))c=join(shift());`;else{var A=new Set(this.preparedJs.abbrs.map((([,e])=>e.charCodeAt(0)))),E=B(A,!0),j=B(A,!1);M+=`for(c=String.fromCharCode(...z);w=/[${j.length<E.length?j:E}]/.exec(c);)with(c.split(w))c=join(shift());`}}switch(I.action){case"eval":M+=`eval(${S})`;break;case"write":M+=`document.write(${S})`;break;case"console":M+=`console.log(${S})`}return{firstLine:C,firstLineLengthInBytes:f,secondLine:M}}async optimizeSparseSelectors(e){var t=await async function(e,t,r){for(var i=e.slice(),s=t(e),n=e.slice(),a=s,o=performance.now(),h=1;h>.1;){var u,c=i.slice();do{u=512*Math.random()|0}while(i.includes(u));i[Math.random()*i.length|0]=u,i.sort(((e,t)=>e-t));var p=t(i),l=!1;p<a&&(n=i.slice(),a=p,l=!0);var d=Math.exp((s-p)/(6*h))<Math.random();if(r){var f={temperature:h,current:i,currentSize:p,currentRejected:d,best:n,bestSize:a,bestUpdated:l};if(!1===await r(f))throw Error("search aborted")}d?i=c:s=p,h*=.99}return{elapsedMsecs:performance.now()-o,best:n,bestSize:a}}(this.options.sparseSelectors,(e=>{this.options.sparseSelectors=e;var{firstLineLengthInBytes:t,secondLine:r}=this.makeDecoder();return t+o(r)}),e);return this.options.sparseSelectors=t.best,t}}var o=e=>{if(e.length>2583||e.match(/[^\0-\xff]/))throw Error("estimateDeflatedSize: too long or non-Latin1 input");var t=[256],r=[],i=0,s={},n=(t,r)=>{var i;for(i=0;i<258&&e[t+i]===e[r+i];++i);return i};e:for(var a=0;a<e.length-3;){var o=3,h=-1,u=s[e.substr(a,3)]||[];for(var c of(s[e.substr(a,3)]=u,u))o<(d=n(a,c))&&(o=d,h=c);if(u.push(a),h<0)t.push(e.charCodeAt(a++));else{for(var c of s[e.substr(a+1,3)]||[])if(o<n(a+1,c)){t.push(e.charCodeAt(a++));continue e}var p,l,d=o-3,f=a-h-1;for(p=0;p<28&&!((d-=1<<Math.max(0,p-4>>2))<0);++p);for(l=0;l<29&&!((f-=1<<Math.max(0,l-2>>1))<0);++l);t.push(257+p),r.push(l),i+=(p<28?Math.max(0,p-4>>2):0)+Math.max(0,l-2>>1),a+=o}}var v=e=>{var t=new Map;for(var r of e)t.set(r,(t.get(r)||0)+1);for(var i=[...t.entries()];i.length>1;){i.sort((([e,t],[r,i])=>i-t||(e<r?-1:e>r?1:0)));var[s,n]=i.pop(),[a,o]=i.pop();i.push([[s,a],n+o])}var h=[],u=0,c=(e,r)=>{e.length?(c(e[0],r+1),c(e[1],r+1)):(h[e]=r,u+=r*t.get(e))};return c(i[0][0],0),[u,h]},[y,m]=v(t),[g,x]=v(r),w=[],b=0,$=-1,B=0;for(var d of[...m,...x,-1])if((d|=0)===$)++B;else{for(;B>=($>0?4:3);){var[C,M,S]=$>0?[16,2,7]:B<11?[17,3,10]:[18,7,138];$>0&&w.push($),w.push(C),b+=M,B-=S}for(;B-- >0;)w.push($);$=d,B=1}var[I]=v(w),k=17+3*Math.max(...w.map((e=>[4,18,16,14,12,10,8,6,5,7,9,11,13,15,17,19,1,2,3][e])))+I+b+y+g+i,A=3+t.reduce(((e,t)=>e+(t<144?8:t<256?9:t<280?7:8)),0)+5*r.length+i;return Math.min(k,A,40+8*e.length)+7>>3},h=1,u=2,c=7,p=8,l=9,d=12,f=13,v=14,y=/\/(?![*\/])(?:\[(?:(?![\]\\]).|\\.)*\]|(?![\/\]\\]).|\\.)*(\/[$_\u200C\u200D\p{ID_Continue}]*|\\)?/uy,m=/--|\+\+|=>|\.{3}|\??\.(?!\d)|(?:&&|\|\||\?\?|[+\-%&|^]|\*{1,2}|<{1,2}|>{1,3}|!=?|={1,2}|\/(?![\/*]))=?|[?~,:;[\](){}]/y,g=/(?=[$_\p{ID_Start}\\])(?:[$_\u200C\u200D\p{ID_Continue}]|\\u[\da-fA-F]{4}|\\u\{[\da-fA-F]+\})+/uy,x=/(['"])(?:(?!\1)[^\\\n\r]|\\(?:\r\n|[^]))*(\1)?/y,w=/(?:0[xX][\da-fA-F](?:_?[\da-fA-F])*|0[oO][0-7](?:_?[0-7])*|0[bB][01](?:_?[01])*)n?|0n|[1-9](?:_?\d)*n|(?:(?:0(?!\d)|0\d*[89]\d*|[1-9](?:_?\d)*)(?:\.(?:\d(?:_?\d)*)?)?|\.\d(?:_?\d)*)(?:[eE][+-]?\d(?:_?\d)*)?|0[0-7]+/y,b=/[`}](?:[^`\\$]|\\[^]|\$(?!\{))*(`|\$\{)?/y,$=/[\t\v\f\ufeff\p{Zs}]+/uy,B=/\r?\n|[\r\u2028\u2029]/y,C=/\/\*(?:[^*]|\*(?!\/))*(\*\/)?/y,M=/\/\/.*/y,S=/^(?:[\/+-]|\.{3}|\?[C-F])?$|[{}([,;<>=*%&|^!~?:]$/,I=/^(?:=>|[;\]){}]|else|\?[EF])?$/,k=/^(?:await|case|default|delete|do|else|instanceof|new|return|throw|typeof|void|yield)$/,A=/^(?:return|throw|yield)$/,E=RegExp(B.source);function*j(e){var t,r,i,s,n,a,o,j,P,z,q,L,D,R;for(({length:a}=e),s=0,n="",R=[{tag:1}],t=[],q=0,L=!1;s<a;){switch((j=R[R.length-1]).tag){case 1:case 2:case 3:if("/"===e[s]&&(S.test(n)||k.test(n))&&(y.lastIndex=s,o=y.exec(e))){s=y.lastIndex,n=o[0],L=!0,yield{type:6,value:o[0],closed:void 0!==o[1]&&"\\"!==o[1]};continue}if(m.lastIndex=s,o=m.exec(e)){switch(P=m.lastIndex,z=D=o[0],D){case"(":"?G"===n&&R.push({tag:2,nesting:q}),q++,L=!1;break;case")":q--,L=!0,2===j.tag&&q===j.nesting&&(R.pop(),z="?F",L=!1);break;case"{":m.lastIndex=0,i=!I.test(n)&&(S.test(n)||k.test(n)),t.push(i),L=!1;break;case"}":if(3===j.tag&&t.length===j.nesting){b.lastIndex=s,o=b.exec(e),s=b.lastIndex,n=o[0],"${"===o[1]?(n="?D",L=!1,yield{type:4,value:o[0]}):(R.pop(),L=!0,yield{type:5,value:o[0],closed:"`"===o[1]});continue}z=(L=t.pop())?"?A":"}";break;case"]":L=!0;break;case"++":case"--":z=L?"?B":"?C";break;case"<":L=!1;break;default:L=!1}s=P,n=z,yield{type:11,value:D};continue}if(g.lastIndex=s,o=g.exec(e)){switch(s=g.lastIndex,z=o[0],o[0]){case"for":case"if":case"while":case"with":"."!==n&&"?."!==n&&(z="?G")}n=z,L=!k.test(o[0]),yield{type:l,value:o[0]};continue}if(x.lastIndex=s,o=x.exec(e)){s=x.lastIndex,n=o[0],L=!0,yield{type:h,value:o[0],closed:void 0!==o[2]};continue}if(w.lastIndex=s,o=w.exec(e)){s=w.lastIndex,n=o[0],L=!0,yield{type:10,value:o[0]};continue}if(b.lastIndex=s,o=b.exec(e)){s=b.lastIndex,n=o[0],"${"===o[1]?(n="?D",R.push({tag:3,nesting:t.length}),L=!1,yield{type:3,value:o[0]}):(L=!0,yield{type:u,value:o[0],closed:"`"===o[1]});continue}}$.lastIndex=s,(o=$.exec(e))?(s=$.lastIndex,yield{type:d,value:o[0]}):(B.lastIndex=s,(o=B.exec(e))?(s=B.lastIndex,L=!1,A.test(n)&&(n="?E"),yield{type:f,value:o[0]}):(C.lastIndex=s,(o=C.exec(e))?(s=C.lastIndex,E.test(o[0])&&(L=!1,A.test(n)&&(n="?E")),yield{type:c,value:o[0],closed:void 0!==o[1]}):(M.lastIndex=s,(o=M.exec(e))?(s=M.lastIndex,L=!1,yield{type:p,value:o[0]}):(s+=(r=String.fromCodePoint(e.codePointAt(s))).length,n=r,L=!1,yield{type:v,value:r}))))}}var P,z=new class{constructor(){this.pool=new Map}allocate(e,t){var r,i=this.pool.get(t);return i&&(r=i.pop()),r||(r=new ArrayBuffer(t)),r}newUint32Array(e,t){return new Uint32Array(this.allocate(e,4*t))}newUint8Array(e,t){return new Uint8Array(this.allocate(e,t))}release(e){var t=this.pool.get(e.byteLength);t||this.pool.set(e.byteLength,t=[]),t.push(e)}},q=!0,L=null,D=0,R=!1,T=()=>{R||J(!1)},F=(e,t,r)=>{var i=t>0?100-r/t*100:-1/0;$outputsize.textContent=`${e}${r.toLocaleString()}B estimated, ${Math.abs(i).toFixed(2)}% ${i>0?"smaller":"larger"}`},J=async e=>{$output.classList.add("c$outdated"),$outputmessage.textContent="",$outputsize.textContent="waiting...",$newwindow.hidden=!0,L=null;var t=D;try{var r=Number($maxmemory.value);if(!(10<=r&&r<=1024))throw"maximum memory usage should be between 10 MB and 1 GB";var i=[];for(var s of $inputs.children)i.push(s.toJS());if(i.some((e=>!e)))return;var n=i.reduce(((e,t)=>e+t.dataOrigLength),0);if(t=++D,q||e)q=!1;else if(await new Promise((e=>setTimeout(e,300))),t!==D)return;$outputsize.textContent=e?"optimizing...":"compressing...",await new Promise((e=>setTimeout(e,1)));var h="",u=new a(i,{maxMemoryMB:r,arrayBufferPool:z,sparseSelectors:e&&P||[0,1,2,3,6,7,13,21,25,42,50,57]});if(e){var c=0,p=await u.optimizeSparseSelectors((async e=>{var t=128336+c++%12;F(String.fromCodePoint(t)+" optimizing: ",n,e.bestSize),console.info(`(T=${e.temperature.toFixed(4)}) trying ${JSON.stringify(e.current)}:`,e.currentSize,e.bestUpdated?"<-":e.rejected?"x":""),await new Promise((e=>requestAnimationFrame(e)))}));h=`optimized in ${(p.elapsedMsecs/1e3).toFixed(1)}s: `,P=p.best}var{firstLine:l,firstLineLengthInBytes:d,secondLine:f}=u.makeDecoder();if(!e&&t!==D)return;L=l+"\n"+f,$output1.textContent=l+"\n",$output2.textContent=f;var v=d+o(f);F(h,n,v),$newwindow.hidden=!1}catch(e){$outputsize.textContent="failed",$outputmessage.textContent="Error: "+e,$output1.textContent=$output2.textContent=""}finally{t===D&&$output.classList.remove("c$outdated")}};$newwindow.onclick=()=>{var e=window.open(""),t=document.createElement("script");t.textContent=L,e.document.head.append(t)},$maxmemory.oninput=()=>{$estimatedmemory.textContent=60*2**Math.floor(Math.log2($maxmemory.value/12/5)),T()},$optimizecontexts.onclick=async()=>{if(!R){R=!0,$optimizecontexts.disabled=!0;try{await J(!0)}finally{R=!1,$optimizecontexts.disabled=!1}}};var _=(()=>{var e=$inputtemplate.content.firstElementChild.cloneNode(!0);for(var t of e.querySelectorAll("[id]"))e[t.id]=t,t.removeAttribute("id");var r="",i=-1;return e.i$data.oninput=()=>{e.i$message.textContent="",null!==(r=e.i$data.value)?(e.i$size.textContent=(i=Array.isArray(r)?r.length:unescape(encodeURIComponent(r)).length).toLocaleString(),T()):(i=-1,e.i$size.textContent="-")},e.i$type.onchange=()=>{e.i$data.oninput(),null!==r&&T()},e.i$action.onchange=()=>{null!==r&&T()},e.toJS=()=>{if(null!==r)return{type:e.i$type.value.replace(/:.*$/,""),data:r,dataOrigLength:i,action:e.i$action.value}},e})();$inputs.append(_),_.i$data.value="document.write`<xmp style=white-space:pre-wrap>\n\n"+$demotext.innerText+"`",_.i$data.oninput(),github.hidden=!0;</script>